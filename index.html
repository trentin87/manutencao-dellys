<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Controle de Manutenção Delly's</title>
<link rel="icon" href="https://www.dellys.com.br/file/v4976781334444797830/general/favicon.png" type="image/png">
<link rel="apple-touch-icon" href="https://www.dellys.com.br/file/v4976781334444797830/general/favicon.png">    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    :root {
        --aberto: #fee2e2; --aberto-text: #991b1b; --aberto-border: #ef4444;
        --andamento: #fef9c3; --andamento-text: #854d0e; --andamento-border: #eab308;
        --aguardando: #ffedd5; --aguardando-text: #9a3412; --aguardando-border: #f97316;
        --finalizado: #dcfce7; --finalizado-text: #166534; --finalizado-border: #22c55e;
        --header-bg: #003366; 
        --btn-add-bg: #059669; --btn-pdf: #dc2626; --btn-xls: #15803d;
        --zebra-bg: #e2e8f0;
    }

    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f1f5f9; color: #333; font-size: 11px; overflow-x: hidden; }
    header { background: var(--header-bg); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .header-title { font-size: 22px; font-weight: 900; letter-spacing: 1.5px; text-transform: uppercase; display: flex; align-items: center; gap: 12px; }
    .truck-icon { width: 32px; height: 32px; fill: currentColor; }
    .logo-img { height: 35px; filter: brightness(0) invert(1); }
    
    .dashboard { display: flex; background: #fff; border-bottom: 1px solid #cbd5e1; padding: 5px 0; overflow-x: auto; }
    .dash-card { flex: 1; min-width: 100px; text-align: center; border-right: 1px solid #eee; padding: 5px; }
    .dash-card .label { font-size: 9px; font-weight: bold; color: #64748b; display: block; }
    .dash-card .val { font-size: 16px; font-weight: 900; }

    .filter-bar { background: #fff; padding: 10px 20px; display: flex; gap: 8px; border-bottom: 1px solid #cbd5e1; align-items: center; overflow-x: auto; }
    body.modo-oficina-active .filter-bar, body.modo-oficina-active .pagination { display: none !important; }

    .btn-fx { border: none; cursor: pointer; font-weight: bold; border-radius: 4px; text-transform: uppercase; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; white-space: nowrap; }
    .btn-fx:hover { opacity: 0.85; filter: brightness(1.1); }
    
    .btn-filter { padding: 6px 12px; border: 1px solid #cbd5e1; background: #f8fafc; color: #475569; }
    .btn-filter.active { background: var(--header-bg); color: white; border-color: var(--header-bg); }
    .btn-add { background: var(--btn-add-bg); color: white; padding: 9px 20px; font-weight: 900; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn-nav { padding: 8px 15px; border: 1px solid #94a3b8; background: #f8fafc; color: #1e293b; }
    .btn-nav.active { background: var(--header-bg); color: white; border-color: var(--header-bg); }
    
    .toolbar { background: #cbd5e1; padding: 10px 20px; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #94a3b8; flex-wrap: wrap; }
    .content-area { padding: 12px; }
    
    .table-container { 
        background: #fff; 
        border: 1px solid #94a3b8; 
        overflow-x: auto; 
        min-height: 450px; 
        border-radius: 4px;
        -webkit-overflow-scrolling: touch;
    }
    
    table { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 1300px; }
    
    /* AQUI VOCÊ AJUSTA AS LARGURAS */
    th:nth-child(1), td:nth-child(1) { width: 25px; }  /* OS */
    th:nth-child(2), td:nth-child(2) { width: 85px; } /* DATA/HORA */
    th:nth-child(3), td:nth-child(3) { width: 50px; }  /* PLACA */
    th:nth-child(4), td:nth-child(4) { width: 90px; } /* MOTORISTA */
    th:nth-child(5), td:nth-child(5) { width: 35px; }  /* KM */
    th:nth-child(6), td:nth-child(6) { width: 90px; } /* SERVIÇO */
    th:nth-child(7), td:nth-child(7) { width: 250px; } /* PROBLEMA */
    th:nth-child(8), td:nth-child(8) { width: 100px; } /* RESPONSÁVEL */
    th:nth-child(9), td:nth-child(9) { width: 250px; } /* OBSERVAÇÕES */
    th:nth-child(10), td:nth-child(10) { width: 90px; }/* STATUS (ÚLTIMA COLUNA) */

    th { background: #1e293b; border: 1px solid #0f172a; padding: 10px 12px; font-size: 10px; color: #fff; position: sticky; top: 0; z-index: 10; text-transform: uppercase; white-space: nowrap; }
    td { border: 1px solid #cbd5e1; padding: 8px; text-align: center; text-transform: uppercase; font-size: 10px; vertical-align: middle; overflow: hidden; }
    
    .wrap-text { 
        white-space: normal !important; 
        text-align: left !important; 
        line-height: 1.25; 
        max-height: 5em; 
        overflow: hidden; 
        word-break: break-word;
        transition: max-height 0.3s ease;
        cursor: pointer;
        width: 100%;
    }
    .wrap-text:hover {
        max-height: 500px; 
        overflow: visible;
        background: rgba(255,255,255,0.95);
        position: relative;
        z-index: 5;
    }

    tbody tr:nth-child(even) { background-color: var(--zebra-bg); }

    .serv-MECÂNICO { background-color: #fee2e2 !important; color: #991b1b; font-weight: bold; border-left: 6px solid #ef4444 !important; }
    .serv-ELÉTRICO { background-color: #fef3c7 !important; color: #92400e; font-weight: bold; border-left: 6px solid #eab308 !important; }
    .serv-REFRIGERAÇÃO { background-color: #dbeafe !important; color: #1e40af; font-weight: bold; border-left: 6px solid #3b82f6 !important; }
    .serv-LAVAGEM { background-color: #f3e8ff !important; color: #6b21a8; font-weight: bold; border-left: 6px solid #a855f7 !important; }
    .serv-OUTROS { background-color: #f4f4f5 !important; color: #3f3f46; font-weight: bold; border-left: 6px solid #71717a !important; }

    .cell-ABERTO { background-color: var(--aberto) !important; color: var(--aberto-text); font-weight: 900; border-left: 6px solid var(--aberto-border) !important; }
    .cell-EM-ANDAMENTO { background-color: var(--andamento) !important; color: var(--andamento-text); font-weight: 900; border-left: 6px solid var(--andamento-border) !important; }
    .cell-AGUARDANDO-PEÇA { background-color: var(--aguardando) !important; color: var(--aguardando-text); font-weight: 900; border-left: 6px solid var(--aguardando-border) !important; }
    .cell-FINALIZADO { background-color: var(--finalizado) !important; color: var(--finalizado-text); font-weight: 900; border-left: 6px solid var(--finalizado-border) !important; }

    .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; padding: 15px; background: #fff; border-top: 1px solid #cbd5e1; flex-wrap: wrap; }
    
    .grid-input { width: 100%; border: none; background: transparent; font-size: 10px; padding: 4px; text-transform: uppercase; outline: none; text-align: center; font-weight: bold; box-sizing: border-box; }
    
    .grid-textarea { 
        width: 100%; border: none; background: transparent; font-size: 10px; padding: 4px; text-transform: uppercase; outline: none; resize: none; font-family: inherit; 
        max-height: 5em; 
        text-align: left; overflow: hidden;
        transition: max-height 0.2s;
        box-sizing: border-box;
        display: block;
    }
    .grid-textarea:focus {
        max-height: 200px;
        overflow-y: auto;
        background: #fff;
        border: 1px solid #94a3b8;
    }
    
    #toast { position: fixed; top: 20px; right: 20px; background: #059669; color: white; padding: 12px 24px; border-radius: 4px; display: none; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .hidden { display: none; }

    @media (max-width: 768px) {
        header { padding: 10px; flex-direction: column; gap: 10px; }
        .header-title { font-size: 14px; }
        .logo-img { height: 25px; }
        #txt-search { width: 100% !important; }
    }
</style>
</head>
<body>

<div id="toast">ATUALIZADO!</div>

<header>
    <div class="header-title">
        <svg class="truck-icon" viewBox="0 0 24 24"><path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM17 12V9.5h2.5l1.97 2.5H17z"/></svg>
        CONTROLE DE MANUTENÇÃO
    </div>
    <img src="https://www.dellys.com.br/ccstore/v1/images/?source=/file/v4051494612781080437/general/Logo_10_png.png" class="logo-img">
</header>

<div class="dashboard">
    <div class="dash-card"><span class="label">TOTAL NO PERÍODO</span><span class="val" id="countTotal">0</span></div>
    <div class="dash-card"><span class="label">ABERTOS</span><span class="val" id="countAberto" style="color:#ef4444">0</span></div>
    <div class="dash-card"><span class="label">EM ANDAMENTO</span><span class="val" id="countAndamento" style="color:#eab308">0</span></div>
    <div class="dash-card"><span class="label">AGUARDANDO PEÇA</span><span class="val" id="countAguardando" style="color:#f97316">0</span></div>
    <div class="dash-card"><span class="label">FINALIZADOS</span><span class="val" id="countFinalizado" style="color:#22c55e">0</span></div>
</div>

<div class="filter-bar">
    <button class="btn-fx btn-filter active" data-status="TODOS" onclick="setFiltroStatus('TODOS')">TODOS</button>
    <button class="btn-fx btn-filter" data-status="ABERTO" onclick="setFiltroStatus('ABERTO')">ABERTO</button>
    <button class="btn-fx btn-filter" data-status="EM ANDAMENTO" onclick="setFiltroStatus('EM ANDAMENTO')">EM ANDAMENTO</button>
    <button class="btn-fx btn-filter" data-status="AGUARDANDO PEÇA" onclick="setFiltroStatus('AGUARDANDO PEÇA')">AGUARDANDO PEÇA</button>
    <button class="btn-fx btn-filter" data-status="FINALIZADO" onclick="setFiltroStatus('FINALIZADO')">FINALIZADO</button>
    
    <div style="margin-left: auto; display: flex; gap: 8px;">
        <select id="filtroPeriodo" onchange="atualizarInterface()" style="padding: 6px; font-weight: bold; border-radius:4px; border:1px solid #cbd5e1; cursor: pointer;">
            <option value="7" selected>ÚLTIMOS 7 DIAS</option>
            <option value="15">ÚLTIMOS 15 DIAS</option>
            <option value="30">ÚLTIMOS 30 DIAS</option>
            <option value="60">ÚLTIMOS 60 DIAS</option>
            <option value="90">ÚLTIMOS 90 DIAS</option>
            <option value="0">HISTÓRICO TOTAL</option>
        </select>
        <button class="btn-fx" onclick="gerarExcel()" style="background:var(--btn-xls); color:white; padding: 6px 12px;">EXCEL</button>
        <button class="btn-fx" onclick="gerarRelatorioPDF()" style="background:var(--btn-pdf); color:white; padding: 6px 12px;">PDF</button>
    </div>
</div>

<div class="toolbar">
    <button class="btn-fx btn-add" onclick="abrirModal()">+ ABRIR CHAMADO</button>
    <button id="nav-consulta" class="btn-fx btn-nav active" onclick="tela('consulta')">CONSULTA GERAL</button>
    <button id="nav-editar" class="btn-fx btn-nav" onclick="tela('editar')">MODO OFICINA</button>
    <input id="txt-search" placeholder="BUSCAR PLACA OU MOTORISTA..." onkeyup="filtrarTudoInstantaneo()" style="padding: 9px; width: 250px; border: 1px solid #94a3b8; border-radius: 4px; margin-left: auto;">
</div>

<div class="content-area">
    <div id="consulta" class="table-container">
        <table>
            <thead>
                <tr>
                    <th>OS</th><th>DATA/HORA</th><th>PLACA</th><th>MOTORISTA</th><th>KM</th><th>SERVIÇO</th>
                    <th>PROBLEMA</th><th>RESPONSÁVEL</th><th>OBSERVAÇÕES</th><th>STATUS</th>
                </tr>
            </thead>
            <tbody id="tbodyConsulta"></tbody>
        </table>
    </div>

    <div id="editar" class="table-container hidden">
        <table>
            <thead>
                <tr>
                    <th>OS</th><th>DATA/HORA</th><th>PLACA</th><th>MOTORISTA</th><th>KM</th><th>SERVIÇO</th>
                    <th>PROBLEMA</th><th>RESPONSÁVEL</th><th>OBSERVAÇÕES</th><th>STATUS</th>
                </tr>
            </thead>
            <tbody id="tbodyOficina"></tbody>
        </table>
    </div>

    <div class="pagination">
        <button class="btn-pag btn-fx" onclick="paginar('first')">|◀</button>
        <button class="btn-pag btn-fx" onclick="paginar('prev')">ANTERIOR</button>
        <span id="pageInfo" style="font-weight: 900; margin: 0 15px;">PÁGINA 1</span>
        <button class="btn-pag btn-fx" onclick="paginar('next')">PRÓXIMA</button>
        <button class="btn-pag btn-fx" onclick="paginar('last')">▶|</button>
    </div>
</div>

<div id="modalOS" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 9999;">
    <div class="modal-box" style="background: white; padding: 25px; border-radius: 8px; width: 450px;">
        <h3 style="margin-top:0; border-bottom: 2px solid var(--btn-add-bg); padding-bottom: 8px; color: var(--btn-add-bg)">Nova Ordem de Serviço</h3>
        <input id="placa" placeholder="PLACA" style="width:100%; padding:10px; margin:8px 0; border:1px solid #cbd5e1; text-transform:uppercase;">
        <input id="motorista" placeholder="MOTORISTA" style="width:100%; padding:10px; margin:8px 0; border:1px solid #cbd5e1; text-transform:uppercase;">
        <input id="km" type="number" placeholder="KM ATUAL" style="width:100%; padding:10px; margin:8px 0; border:1px solid #cbd5e1;">
        <select id="tipoServico" style="width:100%; padding:10px; margin:8px 0; border:1px solid #cbd5e1; cursor:pointer;">
            <option value="MECÂNICO">MECÂNICO</option>
            <option value="ELÉTRICO">ELÉTRICO</option>
            <option value="REFRIGERAÇÃO">REFRIGERAÇÃO</option>
            <option value="LAVAGEM">LAVAGEM</option>
            <option value="OUTROS">OUTROS</option>
        </select>
        <textarea id="problema" placeholder="DESCREVA O PROBLEMA..." rows="3" style="width:100%; padding:10px; margin:8px 0; border:1px solid #cbd5e1; text-transform:uppercase;"></textarea>
        <button class="btn-fx btn-add" style="width:100%; padding: 12px; margin-top:10px" onclick="salvar()">GRAVAR OS</button>
        <button class="btn-fx" style="width:100%; margin-top:10px; border:none; background:transparent; cursor:pointer;" onclick="fecharModal()">CANCELAR</button>
    </div>
</div>

<script>
const URL_GOOGLE = "https://script.google.com/macros/s/AKfycbyUE0CNezRlM0rfYQdDgxn-HUmmnkJJWM6Xz_RiQJ615AHtGI5Hhz9XAJAePhW6sKIOtQ/exec";
let banco = [];
let filtroStatusAtivo = 'TODOS';
let telaAtiva = 'consulta';
let paginaAtual = 1;
const itensPorPagina = 50;

window.onload = () => buscarDados();

async function buscarDados() {
    try {
        const res = await fetch(URL_GOOGLE);
        const json = await res.json();
        banco = json.map(x => ({
            numero: x.numero || Object.values(x)[0],
            data: x.data || Object.values(x)[1],
            placa: (x.placa || Object.values(x)[2] || "").toString().toUpperCase(),
            motorista: (x.motorista || Object.values(x)[3] || "").toString().toUpperCase(),
            km: x.km || Object.values(x)[4] || "-",
            tipo: (x.tipo || Object.values(x)[5] || "OUTROS").toString().toUpperCase(),
            problema: (x.problema || Object.values(x)[6] || "").toString().toUpperCase(),
            status: (x.status || Object.values(x)[7] || "ABERTO").toString().toUpperCase(),
            responsavel: (x.responsavel || Object.values(x)[8] || "").toString().toUpperCase(),
            obs: (x.obs || Object.values(x)[9] || "").toString().toUpperCase(),
            conclusao: x.conclusao || Object.values(x)[10] || ""
        }));
        atualizarInterface();
    } catch (e) { console.error("Erro na carga"); }
}

function atualizarInterface() {
    const dadosPeriodo = getDadosPorPeriodo();
    const c = { 'ABERTO':0, 'EM ANDAMENTO':0, 'AGUARDANDO PEÇA':0, 'FINALIZADO':0 };
    dadosPeriodo.forEach(x => { if(c.hasOwnProperty(x.status)) c[x.status]++; });
    document.getElementById('countTotal').innerText = dadosPeriodo.length;
    document.getElementById('countAberto').innerText = c['ABERTO'];
    document.getElementById('countAndamento').innerText = c['EM ANDAMENTO'];
    document.getElementById('countAguardando').innerText = c['AGUARDANDO PEÇA'];
    document.getElementById('countFinalizado').innerText = c['FINALIZADO'];
    
    document.body.classList.toggle('modo-oficina-active', telaAtiva === 'editar');
    filtrarTudoInstantaneo();
}

function getDadosPorPeriodo() {
    const dias = parseInt(document.getElementById("filtroPeriodo").value);
    const agora = new Date();
    if (dias === 0) return banco;
    return banco.filter(x => (agora - new Date(x.data)) / (1000 * 60 * 60 * 24) <= dias);
}

function getDadosFiltrados() {
    const busca = document.getElementById("txt-search").value.toLowerCase();
    let dados = getDadosPorPeriodo();
    if (telaAtiva === 'editar') { 
        dados = banco.filter(x => x.status !== 'FINALIZADO'); 
    } else { 
        if (filtroStatusAtivo !== 'TODOS') dados = dados.filter(x => x.status === filtroStatusAtivo); 
    }
    return dados.filter(x => x.placa.toLowerCase().includes(busca) || x.motorista.toLowerCase().includes(busca)).reverse();
}

function filtrarTudoInstantaneo() { renderTables(getDadosFiltrados()); }

function renderTables(dados) {
    const isOficina = (telaAtiva === 'editar');
    const tbC = document.getElementById("tbodyConsulta");
    const tbO = document.getElementById("tbodyOficina");

    const totalP = isOficina ? 1 : (Math.ceil(dados.length / itensPorPagina) || 1);
    const paginados = isOficina ? dados : dados.slice((paginaAtual-1)*itensPorPagina, paginaAtual*itensPorPagina);
    document.getElementById("pageInfo").innerText = `PÁGINA ${paginaAtual} DE ${totalP}`;
    tbC.innerHTML = ""; tbO.innerHTML = "";

    if (telaAtiva === 'consulta') {
        tbC.innerHTML = paginados.map(x => {
            const balao = x.status === 'FINALIZADO' && x.conclusao ? `title="FINALIZADO EM: ${new Date(x.conclusao).toLocaleString('pt-BR')}"` : '';
            return `<tr>
                <td>${x.numero}</td><td>${new Date(x.data).toLocaleString('pt-BR')}</td>
                <td><b>${x.placa}</b></td><td><div class="wrap-text">${x.motorista}</div></td><td>${x.km}</td>
                <td class="serv-${x.tipo.replace(/\s/g, "-")}">${x.tipo}</td>
                <td><div class="wrap-text">${x.problema}</div></td>
                <td><div class="wrap-text">${x.responsavel}</div></td>
                <td><div class="wrap-text">${x.obs}</div></td>
                <td class="cell-${x.status.replace(/\s/g, "-")}" ${balao}>${x.status}</td>
            </tr>`}).join('');
    } else {
        tbO.innerHTML = paginados.map(x => `
            <tr>
                <td>${x.numero}</td><td>${new Date(x.data).toLocaleString('pt-BR')}</td>
                <td><b>${x.placa}</b></td><td><div class="wrap-text">${x.motorista}</div></td><td>${x.km}</td>
                <td class="serv-${x.tipo.replace(/\s/g, "-")}" style="padding:0">
                    <select class="grid-input" onchange="atualizarCampo(${x.numero}, 'tipo', this.value)">
                        <option value="MECÂNICO" ${x.tipo==='MECÂNICO'?'selected':''}>MECÂNICO</option>
                        <option value="ELÉTRICO" ${x.tipo==='ELÉTRICO'?'selected':''}>ELÉTRICO</option>
                        <option value="REFRIGERAÇÃO" ${x.tipo==='REFRIGERAÇÃO'?'selected':''}>REFRIGERAÇÃO</option>
                        <option value="LAVAGEM" ${x.tipo==='LAVAGEM'?'selected':''}>LAVAGEM</option>
                        <option value="OUTROS" ${x.tipo==='OUTROS'?'selected':''}>OUTROS</option>
                    </select>
                </td>
                <td><div class="wrap-text">${x.problema}</div></td>
                <td style="padding:0"><textarea class="grid-textarea" onchange="atualizarCampo(${x.numero}, 'responsavel', this.value)">${x.responsavel}</textarea></td>
                <td style="padding:0"><textarea class="grid-textarea" onchange="atualizarCampo(${x.numero}, 'obs', this.value)">${x.obs}</textarea></td>
                <td class="cell-${x.status.replace(/\s/g, "-")}" style="padding:0">
                    <select class="grid-input" onchange="confirmarStatus(this, ${x.numero}, '${x.status}')">
                        <option value="ABERTO" ${x.status==='ABERTO'?'selected':''}>ABERTO</option>
                        <option value="EM ANDAMENTO" ${x.status==='EM ANDAMENTO'?'selected':''}>EM ANDAMENTO</option>
                        <option value="AGUARDANDO PEÇA" ${x.status==='AGUARDANDO PEÇA'?'selected':''}>AGUARDANDO PEÇA</option>
                        <option value="FINALIZADO" ${x.status==='FINALIZADO'?'selected':''}>FINALIZADO</option>
                    </select>
                </td>
            </tr>`).join('');
    }
}

function confirmarStatus(el, num, statusAnterior) {
    if (el.value === "FINALIZADO") {
        if (!confirm("REALMENTE DESEJA FINALIZAR ESTA OS? ELA SAIRÁ DA TELA DA OFICINA.")) {
            el.value = statusAnterior;
            return;
        }
        atualizarCampo(num, 'conclusao', new Date().toISOString());
    }
    atualizarCampo(num, 'status', el.value);
}

async function atualizarCampo(num, campo, valor) {
    const item = banco.find(x => x.numero == num);
    if(item) {
        item[campo] = valor.toUpperCase();
        if(campo === 'status' || campo === 'tipo') atualizarInterface(); else filtrarTudoInstantaneo();
    }
    await fetch(URL_GOOGLE, { method: 'POST', body: JSON.stringify({ action: "update", numero: num, [campo]: valor.toUpperCase() }) });
    showToast();
}

async function salvar() {
    const p = document.getElementById("placa").value.trim();
    const m = document.getElementById("motorista").value.trim();
    if(!p || !m) { alert("PREENCHA PLACA E MOTORISTA!"); return; }
    fecharModal();
    await fetch(URL_GOOGLE, { method: 'POST', body: JSON.stringify({ data: new Date().toISOString(), placa: p.toUpperCase(), motorista: m.toUpperCase(), km: document.getElementById("km").value, tipo: document.getElementById("tipoServico").value, problema: document.getElementById("problema").value.toUpperCase(), status: "ABERTO", responsavel: "", obs: "", conclusao: "" }) });
    buscarDados();
}

function gerarRelatorioPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');
    doc.setFillColor(0, 51, 102); doc.rect(0, 0, 297, 25, 'F');
    doc.setTextColor(255, 255, 255); doc.setFontSize(16); doc.text("CONTROLE DE MANUTENÇÃO - DELLY'S", 15, 15);
    doc.autoTable({ 
        startY: 30, 
        head: [['OS', 'DATA', 'PLACA', 'MOTORISTA', 'KM', 'SERVIÇO', 'PROBLEMA', 'RESPONSÁVEL', 'OBS', 'STATUS']], 
        body: getDadosFiltrados().map(x => [x.numero, new Date(x.data).toLocaleDateString('pt-BR'), x.placa, x.motorista, x.km, x.tipo, x.problema, x.responsavel, x.obs, x.status]),
        styles: { fontSize: 7, textTransform: 'uppercase' },
        headStyles: { fillColor: [30, 41, 59] }
    });
    doc.save(`Relatorio_Frota_Dellys.pdf`);
}

function gerarExcel() {
    const ws = XLSX.utils.json_to_sheet(getDadosFiltrados());
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Manutencao");
    XLSX.writeFile(wb, "Controle_Manutencao.xlsx");
}

function setFiltroStatus(st) { filtroStatusAtivo = st; document.querySelectorAll('.btn-filter').forEach(b => b.classList.toggle('active', b.getAttribute('data-status') === st)); paginaAtual = 1; atualizarInterface(); }
function tela(id) { telaAtiva = id; document.getElementById('consulta').classList.toggle('hidden', id !== 'consulta'); document.getElementById('editar').classList.toggle('hidden', id !== 'editar'); document.getElementById('nav-consulta').classList.toggle('active', id === 'consulta'); document.getElementById('nav-editar').classList.toggle('active', id === 'editar'); paginaAtual = 1; atualizarInterface(); }

function paginar(acao) { 
    const totalP = Math.ceil(getDadosFiltrados().length / itensPorPagina) || 1; 
    if (acao === 'first') paginaAtual = 1;
    else if (acao === 'prev' && paginaAtual > 1) paginaAtual--; 
    else if (acao === 'next' && paginaAtual < totalP) paginaAtual++; 
    else if (acao === 'last') paginaAtual = totalP;
    filtrarTudoInstantaneo(); 
}

function abrirModal() { 
    document.getElementById("placa").value = "";
    document.getElementById("motorista").value = "";
    document.getElementById("km").value = "";
    document.getElementById("problema").value = "";
    document.getElementById("tipoServico").selectedIndex = 0;
    document.getElementById('modalOS').style.display = 'flex'; 
}

function fecharModal() { document.getElementById('modalOS').style.display = 'none'; }
function showToast() { const t = document.getElementById("toast"); t.style.display="block"; setTimeout(()=>t.style.display="none", 2000); }

setInterval(() => {
    const busca = document.getElementById("txt-search");
    const modal = document.getElementById("modalOS");
    if (document.activeElement !== busca && modal.style.display !== "flex") {
        buscarDados();
    }
}, 30000); 
</script>
</body>
</html>
